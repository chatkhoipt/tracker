<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Codeforces Statistics</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root {
    --bg: #f6f8fa;
    --card: #ffffff;
    --border: #d0d7de;
    --text: #24292f;
    --muted: #57606a;
    --accent: #0969da;
    --error: #cf222e;
}

[data-theme="dark"] {
    --bg: #0d1117;
    --card: #161b22;
    --border: #30363d;
    --text: #e6edf3;
    --muted: #8b949e;
    --accent: #2f81f7;
}

* {
    box-sizing: border-box;
}

body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont,
                 "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
}

.container {
    max-width: 900px;
    margin: 40px auto;
    padding: 0 20px;
}

.top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

h1 {
    margin: 0 0 4px 0;
}

.subtitle {
    color: var(--muted);
    margin-bottom: 20px;
}

.card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 25px;
}

label {
    font-weight: 600;
}

input[type="text"] {
    padding: 8px;
    border-radius: 6px;
    border: 1px solid var(--border);
    width: 220px;
    margin-right: 8px;
    background: var(--bg);
    color: var(--text);
}

button {
    padding: 8px 14px;
    border-radius: 6px;
    border: none;
    font-weight: 600;
    cursor: pointer;
}

.primary {
    background: var(--accent);
    color: white;
}

.secondary {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text);
}

button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.handles {
    margin-top: 15px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.handle-chip {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 6px 10px;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.handle-chip span {
    cursor: pointer;
    font-weight: bold;
    color: var(--muted);
}

.error {
    color: var(--error);
    font-weight: 600;
    margin-top: 10px;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

th, td {
    border: 1px solid var(--border);
    padding: 8px 10px;
}

th {
    background: var(--bg);
}

.stats {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}

.stat {
    flex: 1;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 15px;
}

.stat-title {
    color: var(--muted);
    font-size: 13px;
}

.stat-value {
    font-size: 20px;
    font-weight: 700;
}

.spinner {
    margin-left: 10px;
    font-weight: 600;
    color: var(--muted);
    display: none;
}
</style>
</head>

<body>
<div class="container">

<div class="top-bar">
    <div>
        <h1>Codeforces Statistics</h1>
        <div class="subtitle">
            Solved problems from {{ start_date }} (inclusive)
        </div>
    </div>
    <button class="secondary" onclick="toggleTheme()">
        Toggle theme
    </button>
</div>

<div class="card">
    <form method="post" onsubmit="return onSubmit()">
        <label>Add Codeforces handle</label><br><br>

        <input type="text" id="handleInput" placeholder="tourist">
        <button type="button" class="secondary" onclick="addHandle()">
            Add
        </button>

        <div class="handles" id="handlesContainer"></div>

        <input type="hidden" name="handles" id="handlesField">

        <br>
        <button type="submit" id="submitBtn" class="primary">
            Fetch statistics
        </button>
        <span class="spinner" id="spinner">Fetching…</span>

        {% if error %}
            <div class="error">{{ error }}</div>
        {% endif %}
    </form>
</div>

{% if aggregated %}
<div class="stats">
    <div class="stat">
        <div class="stat-title">Unique problems</div>
        <div class="stat-value">{{ aggregated.unique_problems }}</div>
    </div>
    <div class="stat">
        <div class="stat-title">Average rating</div>
        <div class="stat-value">
            {{ "%.2f"|format(aggregated.avg_rating) }}
        </div>
    </div>
</div>
{% endif %}

{% if results %}
<div class="card">
<h3>Per-account breakdown</h3>
<table>
<tr>
    <th>Handle</th>
    <th>Problems</th>
    <th>Rated</th>
    <th>Avg rating</th>
</tr>
{% for h, v in results.items() %}
    {% if v %}
    <tr>
        <td>{{ h }}</td>
        <td>{{ v.problems }}</td>
        <td>{{ v.rated_problems }}</td>
        <td>{{ "%.2f"|format(v.avg_rating) }}</td>
    </tr>
    {% else %}
    <tr>
        <td>{{ h }}</td>
        <td colspan="3">ERROR</td>
    </tr>
    {% endif %}
{% endfor %}
</table>
</div>
{% endif %}

</div>

<script>
let handles = JSON.parse(localStorage.getItem("handles") || "[]");

function saveHandles() {
    localStorage.setItem("handles", JSON.stringify(handles));
}

function renderHandles() {
    const c = document.getElementById("handlesContainer");
    c.innerHTML = "";
    handles.forEach(h => {
        const d = document.createElement("div");
        d.className = "handle-chip";
        d.innerHTML = `${h} <span onclick="removeHandle('${h}')">×</span>`;
        c.appendChild(d);
    });
    document.getElementById("handlesField").value = handles.join(" ");
}

function addHandle() {
    const inp = document.getElementById("handleInput");
    const h = inp.value.trim();
    if (h && !handles.includes(h)) {
        handles.push(h);
        saveHandles();
        renderHandles();
    }
    inp.value = "";
}

function removeHandle(h) {
    handles = handles.filter(x => x !== h);
    saveHandles();
    renderHandles();
}

function onSubmit() {
    if (handles.length === 0) return false;
    document.getElementById("submitBtn").disabled = true;
    document.getElementById("spinner").style.display = "inline";
    return true;
}

/* -------- THEME LOGIC (FIXED) -------- */

function toggleTheme() {
    const current = document.documentElement.getAttribute("data-theme") || "light";
    const next = current === "dark" ? "light" : "dark";
    document.documentElement.setAttribute("data-theme", next);
    localStorage.setItem("theme", next);
}

(function init() {
    renderHandles();
    const savedTheme = localStorage.getItem("theme") || "light";
    document.documentElement.setAttribute("data-theme", savedTheme);
})();
</script>

</body>
</html>
